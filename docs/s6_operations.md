# S-6 Stable 安定運用ガイド

**S-6 stable 安定運用開始日: 2025-12-14**

本ドキュメントは S-6 stable フェーズの安定運用に必要なすべてのルールを集約しています。

---

## A. 運用フロー

### S-6 標準実行フロー（1ページ要約）

```
[準備] checkpoint 作成
    ↓
[初回] cleanrun で初期化実行
    ↓
[検証] test モードで状態確認
    ↓
[継続] run モードで繰り返し
    ↓
[完了] job_loop_complete
    ↓
[確認] test モードで最終検証
```

### 実行順序ルール

#### 正順（必ず守る）

```
cleanrun → test → run
```

1. **cleanrun**: 初期状態から開始
2. **test**: 状態が正常であることを確認
3. **run**: 継続実行

#### 禁止順序（絶対にやってはいけない）

```
run → test → cleanrun  ← 禁止
```

- cleanrun なしで run を開始してはいけない
- test で失敗した状態で run を継続してはいけない
- cleanrun は状態をリセットするため、途中で実行すると進捗が失われる

### job_loop の停止条件

job_loop は以下の条件で停止します：

1. **正常停止**: job_index > max_jobs（job_loop_complete）
2. **異常停止**: deny, fatal_error, stopped
3. **手動停止**: Ctrl+C または プロセス終了

### job_loop_complete の扱い

- **phase**: job_loop_complete
- **意味**: max_jobs に到達し、正常に完了
- **test 結果**: passed（エラーではない）
- **次のアクション**: job_result.json を確認し、次の作業へ

### 手動停止時の正しい手順

1. **Ctrl+C で停止**（または PowerShell ウィンドウを閉じる）
2. **logs/ 配下を確認**（最後の step_*.json を確認）
3. **test モードで状態確認**
4. **必要に応じて rollback**

### 異常停止時の再開手順

1. **ログを確認**（logs/steps/ 配下）
2. **異常の原因を特定**
   - deny: config の deny_if_contains を確認
   - fatal_error: API キーやネットワークを確認
   - stopped: stop_on_deny 設定を確認
3. **rollback を実行**
4. **原因を解消**
5. **cleanrun から再開**

---

## B. 安定運用ルール

### 人的ミス想定

S-6 運用で想定される人的ミス：

| ミス | 影響 | 予防策 |
|------|------|--------|
| checkpoint 忘れ | rollback 不可 | 実行前チェックリスト |
| cleanrun 前に run | 不整合状態 | 正順を徹底 |
| test 確認忘れ | 異常見逃し | test 必須化 |
| config 誤編集 | 実行失敗 | 編集前 checkpoint |
| API キー期限切れ | API エラー | 週次確認 |

### 誤操作時の被害最小化手順

1. **即座に実行を停止**
2. **現状を記録**（スクリーンショット、ログコピー）
3. **rollback を検討**
4. **checkpoint があれば rollback**
5. **checkpoint がなければ cleanrun から再開**

### config 編集前の必須確認事項

config_v0_3.json を編集する前に：

- [ ] checkpoint を作成した
- [ ] 変更内容を記録した（何を、なぜ）
- [ ] 変更がスキーマ変更でないことを確認した
- [ ] 変更が禁止事項に該当しないことを確認した

### API キー変更時の手順

1. 新しい API キーを取得
2. 環境変数を更新
3. PowerShell を再起動（または新しいセッションを開始）
4. test モードで API 接続を確認

### ログ確認の必須ポイント

実行後に確認すべきログ：

1. **phase**: done または job_loop_complete であること
2. **job_index**: 期待値と一致すること
3. **end_reason**: 正常終了であること
4. **エラー**: エラーメッセージがないこと

### 日次確認項目

- [ ] 直近の実行ログに異常がないか
- [ ] API 呼び出しにエラーがないか
- [ ] 予期しない phase がないか

### 週次確認項目

- [ ] API キーの有効期限
- [ ] ログファイルの蓄積状況
- [ ] git リポジトリの状態
- [ ] checkpoint の作成状況

### 異常検知の初期兆候

以下の兆候が見られたら注意：

1. **API 応答遅延**: 通常より遅い
2. **エラー頻度増加**: 連続エラー
3. **予期しない phase**: deny, fatal_error
4. **ログ欠損**: step_*.json が生成されない
5. **出力不一致**: 期待と異なる結果

### 障害時の一次対応範囲

一次対応者が行う範囲：

1. 実行の停止
2. ログの保存
3. rollback の実行
4. test モードでの確認
5. 障害内容の記録

### 二次対応へ引き継ぐ条件

以下の場合は二次対応（または専門家）へ引き継ぐ：

- rollback しても復旧しない
- 原因が特定できない
- config 以外の変更が必要
- 実装コードの修正が必要

---

## C. ログ・証跡運用

### 安定運用時の必須ログ一覧

| ログ | 場所 | 必須/任意 |
|------|------|----------|
| step_*.json | logs/steps/ | 必須 |
| last_run_summary.json | logs/ | 必須 |
| last_run_summary.txt | logs/ | 必須 |
| phase_summary.json | workspace/artifacts/ | 必須 |
| job_result.json | workspace/artifacts/ | 必須（完了時） |

### 保管必須ログと任意ログ

**保管必須**:
- phase_summary.json（実行結果の証跡）
- job_result.json（ジョブ完了の証跡）
- last_run_summary.json（最新実行の記録）

**任意**:
- step_*.json（詳細デバッグ用、上書きされる）
- last_run_summary.txt（人間可読形式）

### ログ削除が許可される条件

以下の条件をすべて満たす場合のみ削除可能：

1. 該当ログが「保管必須」でない
2. 該当実行が正常完了している
3. checkpoint で git に保存済み
4. 30日以上経過している

### ログ保全の責任者

- 運用担当者がログ保全の責任を負う
- 障害時のログは必ずバックアップを取る
- 重要なログは checkpoint で git に保存

### 障害時に提出すべきログ

障害報告時に提出するログ：

1. **logs/steps/step_*.json**（直近の実行ログ）
2. **logs/last_run_summary.json**
3. **workspace/artifacts/phase_summary.json**
4. **エラーメッセージのスクリーンショット**

### SummaryFile の保存期間

- **推奨保存期間**: 90日
- **最低保存期間**: 30日
- **保存方法**: checkpoint で git に保存

### phase_summary.json の参照ルール

- 実行結果の確認に使用
- job_loop の状態確認に使用
- 障害調査時の一次情報源として使用

### last_run_summary.txt の活用方法

- 1行形式で即座に状態確認
- スクリプトでのパースに使用
- 簡易的な監視に使用

### ログ欠損時の扱い

ログが欠損している場合：

1. **原因を調査**（実行中断、ディスク障害など）
2. **欠損範囲を特定**
3. **再実行が必要か判断**
4. **再実行する場合は cleanrun から開始**

### 証跡不足時の再実行ルール

証跡が不足している場合：

1. checkpoint を作成
2. cleanrun で初期状態から再実行
3. test モードで検証
4. ログが正しく生成されていることを確認

---

## D. 人・組織前提

### 運用担当者の役割

運用担当者の責任：

1. 本ガイドに従った運用の実施
2. 定期確認の実施
3. 障害時の一次対応
4. ログの保全
5. 異常の報告

### 権限分離（実行者／承認者）

| 役割 | 権限 | 責任 |
|------|------|------|
| 実行者 | 通常運用の実行 | 手順遵守、ログ保全 |
| 承認者 | config 変更の承認 | 変更の妥当性確認 |

### 複数人運用時の衝突回避ルール

1. **同時実行禁止**: 1人のみが実行
2. **実行前に確認**: 他の人が実行中でないか確認
3. **実行中の明示**: 実行中であることを共有
4. **完了の報告**: 実行完了を共有

### 引き継ぎ時の必須確認項目

引き継ぎ時に確認すべき項目：

- [ ] 最新の checkpoint が作成されているか
- [ ] 直近の実行が正常完了しているか
- [ ] 未完了のタスクがないか
- [ ] 異常な状態が残っていないか
- [ ] API キーの有効期限

### 外部委託時の注意点

外部に委託する場合：

1. 本ガイドを共有
2. API キーの管理方法を確認
3. ログの取り扱いを確認
4. 障害時の連絡フローを確認
5. 正史コンテキストへの準拠を確認

### AI 任せにしてはいけない判断

以下の判断は人間が行う：

1. **実行開始の判断**: 状況を確認してから開始
2. **異常時の対応判断**: rollback か継続か
3. **config 変更の判断**: 変更の妥当性
4. **緊急停止の判断**: 停止が必要かどうか
5. **例外対応の判断**: ルール外の対応

### 人間確認が必須なポイント

以下のポイントは必ず人間が確認：

1. **実行前**: checkpoint が作成されているか
2. **実行後**: test モードの結果
3. **完了時**: job_result.json の内容
4. **異常時**: エラーの内容と対処

### 緊急停止判断の責任者

- 運用担当者が緊急停止の判断を行う
- 判断に迷った場合は停止を優先
- 停止後に状況を確認・報告

### 例外対応の承認フロー

ルール外の対応が必要な場合：

1. 例外対応の内容を明確化
2. 承認者に報告
3. 承認を得てから実行
4. 実行結果を報告
5. ルールの見直しを検討

### ルール逸脱時の是正プロセス

ルールから逸脱した場合：

1. 逸脱の内容を記録
2. 影響範囲を確認
3. 必要に応じて rollback
4. 再発防止策を検討
5. ルールの見直しを検討

---

## 正史コンテキスト v1.0 との整合

本ドキュメントは正史コンテキスト v1.0 に準拠しています。

- S-5 で確立した仕様を継承
- 新機能追加・仕様変更は行わない
- 本ドキュメントが唯一の正しい運用情報源

### 正史更新履歴

- 2025-12-14: S-5 closeout 完了
- 2025-12-14: S-6 stable 開始
- 2025-12-14: S-6 stable 安定運用開始
