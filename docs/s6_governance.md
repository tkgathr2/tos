# S-6 Stable ガバナンス・判断基準

**S-6 stable 完成日: 2025-12-14**

本ドキュメントは S-6 stable フェーズの判断基準、拡張ルール、リスク・限界、引き継ぎ耐性を定義します。

---

## A. 判断基準の明文化

### A-1. 運用継続して良い状態の定義

以下のすべてを満たす場合、運用を継続してよい：

1. **正常終了**: phase が `done` または `job_loop_complete` である
2. **エラーなし**: fatal_error, deny, stopped が発生していない
3. **ログ正常**: step_*.json, last_run_summary.json が正常に生成されている
4. **API 応答正常**: API 呼び出しがタイムアウトなく完了している
5. **出力妥当**: job_result.json の内容が想定範囲内である

### A-2. 即停止すべき状態の定義

以下のいずれかに該当する場合、即座に実行を停止する：

1. **fatal_error 発生**: API エラー、認証失敗、ネットワーク障害
2. **deny 連続発生**: 3回以上連続して deny が発生
3. **想定外 phase**: 定義されていない phase が出現
4. **ログ欠損**: step_*.json が生成されない
5. **出力異常**: job_result.json が破損または異常な内容
6. **リソース枯渇**: ディスク容量不足、メモリ不足
7. **セキュリティ懸念**: API キー漏洩の疑い、不正アクセスの兆候

### A-3. 人間判断が必須な分岐条件

以下の判断は人間が行う（AI に委任しない）：

| 判断項目 | 理由 |
|---------|------|
| 実行開始の可否 | 状況確認が必要 |
| 異常時の継続/停止 | リスク判断が必要 |
| rollback の実行可否 | データ損失リスク |
| config 変更の適用 | 運用影響の判断 |
| 緊急停止の判断 | 即時性が必要 |
| 例外対応の承認 | ルール外の判断 |
| 拡張検討の開始 | 戦略的判断 |

### A-4. AI に判断させてよい範囲

以下は AI に判断を委任してよい：

1. **ログ解析**: step_*.json の内容分析
2. **状態確認**: phase_state.json の読み取りと報告
3. **エラー分類**: エラーメッセージの種類判定
4. **推奨提示**: 対処方法の候補提示（実行は人間）
5. **ドキュメント参照**: 手順書の検索と提示

### A-5. 人間レビュー必須ポイント

以下のポイントは必ず人間がレビューする：

1. **実行前**: checkpoint が作成されているか
2. **実行後**: test モードの結果
3. **完了時**: job_result.json の内容
4. **異常時**: エラーの内容と対処方針
5. **変更時**: config 変更前後の差分

### A-6. 例外判断の承認者

| 例外種別 | 承認者 | 承認方法 |
|---------|--------|---------|
| 軽微な例外 | 運用担当者 | 判断記録を残す |
| config 変更 | 承認者 | 変更前レビュー |
| ルール逸脱 | 承認者 | 書面承認 |
| 拡張検討 | 承認者 | 正式検討開始 |

### A-7. 判断記録を残すべきケース

以下のケースでは判断記録を残す：

1. 例外対応を行った場合
2. 通常と異なる手順を取った場合
3. ルールの解釈に迷った場合
4. 異常を発見したが継続した場合
5. 拡張検討を却下した場合

**記録フォーマット**:
```
日時: YYYY-MM-DD HH:MM
判断者: (氏名)
状況: (発生した状況)
判断: (行った判断)
理由: (判断の理由)
結果: (判断後の結果)
```

---

## B. 拡張可否ルール

### B-1. S-6 内で許可される軽微拡張

以下は S-6 stable 内で許可される：

1. **ドキュメント修正**: 誤字脱字、説明の明確化
2. **ログ文言修正**: エラーメッセージの改善
3. **コメント追加**: コード内コメントの追加
4. **軽微なバグ修正**: 動作に影響を与えない修正（承認後）

### B-2. S-6 では絶対に行わない拡張

以下は S-6 stable 内で絶対に行わない：

1. **新機能追加**: 新しい機能の実装
2. **仕様変更**: 既存動作の変更
3. **設定スキーマ変更**: config_v0_3.json の構造変更
4. **入出力形式変更**: job_input.json, job_result.json の形式変更
5. **破壊的変更**: 後方互換性を損なう変更
6. **依存関係変更**: 外部ライブラリの追加・変更
7. **API バージョン変更**: 使用 API のバージョン変更

### B-3. 拡張検討を開始してよい条件

以下のすべてを満たす場合、拡張検討を開始してよい：

1. S-6 stable が安定運用されている（30日以上）
2. 明確な業務要件がある
3. 現行機能では対応不可能である
4. 承認者が検討開始を承認した
5. 検討リソースが確保されている

### B-4. S-7 への移行検討条件

以下のいずれかに該当する場合、S-7 への移行を検討する：

1. **機能要件**: S-6 では実現不可能な新機能が必要
2. **技術要件**: 依存ライブラリの EOL 対応が必要
3. **スケール要件**: 現行アーキテクチャの限界に達した
4. **セキュリティ要件**: セキュリティ上の根本対応が必要

### B-5. PoC を許可する場合の制限条件

PoC（Proof of Concept）を許可する場合：

1. **別ブランチ必須**: main ブランチでは行わない
2. **期間限定**: 最大2週間
3. **影響分離**: 本番環境に影響を与えない
4. **記録必須**: PoC の目的・結果を記録
5. **破棄前提**: PoC コードは原則破棄

### B-6. 一時的フラグ導入の可否

S-6 stable では一時的フラグの導入は**原則禁止**。

例外的に許可される条件：
1. 緊急のバグ対応である
2. 既存動作を変更しない
3. 7日以内に削除する計画がある
4. 承認者が承認した

### B-7. 拡張検討時の必須チェックリスト

拡張を検討する際の必須確認項目：

- [ ] 現行機能で代替不可能か確認した
- [ ] 業務要件が明確に定義されている
- [ ] S-6 の禁止事項に該当しないか確認した
- [ ] 影響範囲を特定した
- [ ] ロールバック計画がある
- [ ] テスト計画がある
- [ ] 承認者の承認を得た

### B-8. 拡張判断の記録フォーマット

```
拡張検討ID: EXT-YYYYMMDD-NNN
検討日: YYYY-MM-DD
提案者: (氏名)
内容: (拡張内容の概要)
理由: (拡張が必要な理由)
影響: (影響範囲)
判断: (承認/却下/保留)
判断者: (氏名)
判断理由: (判断の理由)
次アクション: (次に行うこと)
```

### B-9. 拡張却下時の扱い

拡張が却下された場合：

1. 却下理由を記録に残す
2. 提案者にフィードバックする
3. 同一内容の再提案は3ヶ月後から可能
4. 状況が変化した場合は早期再提案可能
5. 却下記録は正史に残す

### B-10. 拡張議論を正史に残すルール

以下の拡張議論は正史に記録する：

1. 正式に検討された拡張提案
2. S-7 移行検討
3. 却下された重要な提案
4. 将来検討とされた提案

記録場所: `docs/extension_log.md`（必要時に作成）

---

## C. リスク・限界の明示

### C-1. 現在の TOS v0.3 の技術的限界

1. **単一プロセス**: 並列実行に非対応
2. **同期実行**: 非同期処理に非対応
3. **ローカル実行**: リモート実行に非対応
4. **Windows 専用**: 他 OS での動作未検証
5. **Python 3.12+ 必須**: 古いバージョン非対応

### C-2. スケール上の限界

1. **max_jobs**: 設定値が上限
2. **ログサイズ**: 長期運用でログが肥大化
3. **同時実行**: 1インスタンスのみ
4. **データ量**: job_payload は 2000 文字まで（sanitized）

### C-3. 想定外入力に対する限界

1. **巨大ペイロード**: メモリ不足の可能性
2. **不正 JSON**: パースエラーで停止
3. **特殊文字**: エスケープ処理に依存
4. **空入力**: 動作未定義の可能性

### C-4. AI API 依存によるリスク

1. **API 障害**: 外部サービス停止で動作不可
2. **料金**: API 呼び出しに課金が発生
3. **レート制限**: 頻繁な呼び出しで制限される可能性
4. **応答品質**: AI の応答品質に依存
5. **API 仕様変更**: 外部 API の仕様変更リスク

### C-5. レート制限・障害時の制約

| 状況 | 制約 | 対処 |
|------|------|------|
| レート制限 | 一時的に実行不可 | 時間を置いて再試行 |
| API 障害 | 実行不可 | 障害復旧を待つ |
| 認証失敗 | 実行不可 | API キーを確認 |
| タイムアウト | 不完全な結果 | 再試行 |

### C-6. 人的オペレーション限界

1. **24時間監視不可**: 常時監視は想定外
2. **即時対応不可**: 障害発生から対応までにラグ
3. **属人化リスク**: 担当者不在時のリスク
4. **判断ミス**: 人間の判断にも誤りの可能性

### C-7. ログ肥大化時の限界

1. **ディスク容量**: ログが蓄積すると容量圧迫
2. **検索性能**: 大量ログの検索に時間がかかる
3. **管理負荷**: 古いログの管理が必要

**対策**:
- 30日以上経過した任意ログは削除可能
- 重要ログは checkpoint で git に保存
- 定期的なログローテーション推奨

### C-8. 長期運用時の注意点

1. **API キー更新**: 定期的な更新が必要
2. **依存ライブラリ更新**: セキュリティパッチ適用
3. **ドキュメント陳腐化**: 実態との乖離に注意
4. **担当者変更**: 引き継ぎの品質維持
5. **環境変化**: OS/Python のアップデート

### C-9. 既知の未対応事項

| 項目 | 状態 | 対応予定 |
|------|------|---------|
| マルチプロセス | 未対応 | S-7 以降検討 |
| リモート実行 | 未対応 | 未定 |
| GUI | 未対応 | 未定 |
| 自動リトライ | 未対応 | S-7 以降検討 |
| 監視アラート | 未対応 | 外部ツール連携で対応可 |

### C-10. 限界を受け入れる前提

TOS v0.3 S-6 stable は以下の前提で運用する：

1. **完璧ではない**: 限界があることを理解して使用する
2. **人間が主体**: AI は補助であり、判断は人間が行う
3. **段階的改善**: 必要に応じて S-7 で改善する
4. **正史が基準**: ドキュメントに記載された範囲で運用する
5. **無理をしない**: 限界を超える要求には対応しない

---

## D. 将来引き継ぎ耐性

### D-1. 新担当者が最初に理解すべき要点

1. **TOS とは何か**: AI タスクオーケストレーター
2. **S-6 とは何か**: 安定運用フェーズ
3. **正史コンテキスト**: 唯一の正しい情報源
4. **正順**: cleanrun → test → run
5. **checkpoint/rollback**: 安全装置として必須

### D-2. 誤解されやすいポイント

| 誤解 | 正しい理解 |
|------|-----------|
| S-5 を使える | S-5 は履歴フェーズ（凍結） |
| 新機能を追加できる | S-6 では新機能追加禁止 |
| AI が判断する | 重要判断は人間が行う |
| run だけで動く | cleanrun が必須 |
| エラーは無視してよい | エラーは必ず対処 |

### D-3. 読み飛ばしてはいけない文書

以下の文書は必ず通読すること：

1. **README.md** - 概要と正史コンテキスト
2. **docs/s6_stable.md** - S-6 運用ルール
3. **docs/s6_operations.md** - 安定運用ガイド
4. **docs/s6_governance.md** - 本ドキュメント（判断基準）

### D-4. 引き継ぎ時の口頭説明必須事項

口頭で必ず説明すべき事項：

1. **日常運用の流れ**: 実際の操作デモ
2. **異常時の対応**: 過去に発生した問題と対処
3. **やってはいけないこと**: 禁止事項の強調
4. **連絡先**: 問題発生時の連絡先
5. **暗黙知**: ドキュメントに書ききれない知見

### D-5. 引き継ぎ失敗時のリカバリ手順

引き継ぎが不完全だった場合：

1. **ドキュメント再読**: README から順に再読
2. **test モード実行**: 現状確認
3. **ログ確認**: 直近の実行履歴を確認
4. **前任者連絡**: 可能であれば質問
5. **慎重に再開**: checkpoint を取って再開

### D-6. 運用停止判断の引き継ぎ方法

運用停止が必要な場合の引き継ぎ：

1. **停止理由の記録**: なぜ停止するか
2. **現状の保存**: checkpoint を作成
3. **再開条件の明記**: いつ再開できるか
4. **連絡先の明記**: 再開判断を誰に相談するか

### D-7. 属人化を避けるためのルール

1. **ドキュメント最優先**: 口頭伝達よりドキュメント
2. **変更は記録**: 暗黙の変更を禁止
3. **複数人レビュー**: 重要判断は複数人で
4. **定期的な引き継ぎ訓練**: 属人化チェック
5. **正史への集約**: 分散した情報を正史に集約

### D-8. 正史更新時のレビュー体制

正史（ドキュメント）を更新する場合：

1. **変更内容の明確化**: 何を、なぜ変更するか
2. **レビュー依頼**: 承認者にレビュー依頼
3. **影響確認**: 他ドキュメントへの影響確認
4. **承認後に反映**: レビュー通過後に適用
5. **変更履歴更新**: release_notes.md に記録

### D-9. 正史改訂を拒否できる条件

以下の場合、正史改訂を拒否できる：

1. S-6 の禁止事項に該当する変更
2. 根拠が不明確な変更
3. 影響範囲が不明な変更
4. 承認者の承認がない変更
5. 正史コンテキスト v1.0 に違反する変更

### D-10. 引き継ぎ完了判定基準

引き継ぎ完了と判定する条件：

- [ ] 新担当者が README から s6_governance.md まで通読した
- [ ] 新担当者が単独で cleanrun → test → run を実行できた
- [ ] 新担当者が checkpoint/rollback を実行できた
- [ ] 新担当者が異常時の対応手順を説明できた
- [ ] 新担当者が禁止事項を説明できた
- [ ] 1週間の単独運用で問題が発生しなかった

---

## 正史コンテキスト v1.0 との整合

本ドキュメントは正史コンテキスト v1.0 に準拠しています。

- S-5 で確立した仕様を継承
- 新機能追加・仕様変更は行わない
- 本ドキュメントが判断基準・ガバナンスの唯一の正しい情報源

### 正史更新履歴

- 2025-12-14: S-5 closeout 完了
- 2025-12-14: S-6 stable 開始
- 2025-12-14: S-6 stable 安定運用開始
- 2025-12-14: S-6 stable 完成（本ドキュメント作成）
