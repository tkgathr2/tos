# S-7 検討提案書

**検討日: 2025-12-14**
**検討ID: EXT-20251214-001**

本ドキュメントは S-7（拡張フェーズ）の必要性を正史に基づき検討した結果を記録します。

---

## A. 要件整理

### A-1. S-7 で追加したいこと（候補一覧）

S-6 governance で「既知の未対応事項」として挙げられた項目を中心に列挙：

1. **自動リトライ機能**: API エラー時の自動再試行
2. **マルチプロセス対応**: 並列実行による高速化
3. **ログローテーション自動化**: 古いログの自動削除/アーカイブ
4. **監視アラート連携**: 異常検知時の通知機能
5. **リモート実行対応**: ネットワーク経由での実行
6. **GUI**: グラフィカルユーザーインターフェース
7. **クロスプラットフォーム対応**: macOS/Linux での動作

### A-2. 各項目の目的（なぜ必要か）

| 項目 | 目的 |
|------|------|
| 自動リトライ | 一時的な API 障害からの自動復旧 |
| マルチプロセス | 大量ジョブの処理時間短縮 |
| ログローテーション | 長期運用時のディスク管理自動化 |
| 監視アラート | 異常の早期発見と迅速な対応 |
| リモート実行 | 複数マシンでの分散実行 |
| GUI | 非技術者でも操作可能に |
| クロスプラットフォーム | 利用環境の選択肢拡大 |

### A-3. 各項目の利用者（誰が使うか）

| 項目 | 利用者 |
|------|--------|
| 自動リトライ | 運用担当者（自動で動作） |
| マルチプロセス | 大量処理が必要な運用者 |
| ログローテーション | 長期運用担当者 |
| 監視アラート | 運用監視担当者 |
| リモート実行 | インフラ担当者 |
| GUI | 非技術者、エンドユーザー |
| クロスプラットフォーム | macOS/Linux ユーザー |

### A-4. 各項目の頻度（毎日/週次/随時）

| 項目 | 頻度 |
|------|------|
| 自動リトライ | 随時（エラー発生時） |
| マルチプロセス | 毎日（大量処理時） |
| ログローテーション | 週次/月次 |
| 監視アラート | 随時（異常発生時） |
| リモート実行 | 随時 |
| GUI | 毎日 |
| クロスプラットフォーム | 随時 |

### A-5. 各項目の成功条件

| 項目 | 成功条件 |
|------|---------|
| 自動リトライ | 一時的エラーから自動復旧し、ジョブが完了する |
| マルチプロセス | 並列実行により処理時間が短縮される |
| ログローテーション | 古いログが自動削除され、ディスク容量が管理される |
| 監視アラート | 異常発生時に通知が届き、迅速な対応が可能になる |
| リモート実行 | ネットワーク経由で正常に実行・結果取得できる |
| GUI | コマンドなしで操作・監視ができる |
| クロスプラットフォーム | macOS/Linux で同等の動作が確認できる |

### A-6. 既存 S-6 で代替できない理由

| 項目 | S-6 で代替できない理由 |
|------|----------------------|
| 自動リトライ | 現状は手動再実行のみ |
| マルチプロセス | 単一プロセス設計のため不可 |
| ログローテーション | 手動削除のみ対応 |
| 監視アラート | 外部ツール連携が必要 |
| リモート実行 | ローカル実行のみ対応 |
| GUI | コマンドラインのみ |
| クロスプラットフォーム | Windows 専用設計 |

### A-7. 不要になった場合の撤回条件

| 項目 | 撤回条件 |
|------|---------|
| 自動リトライ | API が安定し、手動リトライで十分な場合 |
| マルチプロセス | 処理量が増えず、現行速度で十分な場合 |
| ログローテーション | 手動管理で問題ない場合 |
| 監視アラート | 外部ツールで十分な場合 |
| リモート実行 | ローカル実行のみで十分な場合 |
| GUI | コマンドライン運用で十分な場合 |
| クロスプラットフォーム | Windows 環境のみで運用する場合 |

---

## B. 影響範囲の洗い出し

### B-1. 変更が入る可能性のあるファイル

| 項目 | 変更対象ファイル |
|------|----------------|
| 自動リトライ | orchestrator_v0_3.py, config_v0_3.json |
| マルチプロセス | orchestrator_v0_3.py, cc_run.ps1 |
| ログローテーション | cc_run.ps1, 新規スクリプト |
| 監視アラート | 新規スクリプト/設定 |
| リモート実行 | 大幅な設計変更 |
| GUI | 新規アプリケーション |
| クロスプラットフォーム | cc_run.ps1 の bash 版、パス処理 |

### B-2. 変更が入る可能性のある入出力

| 項目 | 入出力への影響 |
|------|--------------|
| 自動リトライ | retry_count を step_log に追加 |
| マルチプロセス | 並列実行結果のマージ |
| ログローテーション | ログファイル構造の変更可能性 |
| 監視アラート | アラート設定の入力追加 |
| リモート実行 | ネットワーク設定の入力追加 |
| GUI | 画面入出力追加 |
| クロスプラットフォーム | パス形式の統一 |

### B-3. 変更が入る可能性のあるログ

| 項目 | ログへの影響 |
|------|------------|
| 自動リトライ | retry 情報の追加 |
| マルチプロセス | プロセス ID の追加 |
| ログローテーション | ログファイル名規則の変更 |
| 監視アラート | アラート履歴の追加 |
| リモート実行 | 実行ホスト情報の追加 |
| GUI | 操作ログの追加 |
| クロスプラットフォーム | パス表記の統一 |

### B-4. 後方互換性に影響する点

- config_v0_3.json のスキーマ変更
- step_log のフィールド追加
- ログファイル構造の変更
- 実行手順の変更

### B-5. セキュリティ/安全性に影響する点

- リモート実行: ネットワーク経由のセキュリティリスク
- 監視アラート: 通知先の認証情報管理
- GUI: 認証/認可の追加

### B-6. 運用手順に影響する点

- 新機能の操作手順追加
- トラブルシューティング手順の更新
- 引き継ぎドキュメントの更新

### B-7. 失敗時ロールバック難度

| 項目 | ロールバック難度 |
|------|----------------|
| 自動リトライ | 低（設定変更で無効化可能） |
| マルチプロセス | 中（コード変更が必要） |
| ログローテーション | 低（スクリプト削除で無効化） |
| 監視アラート | 低（設定変更で無効化可能） |
| リモート実行 | 高（設計変更が大きい） |
| GUI | 低（別アプリのため分離可能） |
| クロスプラットフォーム | 中（テスト環境の整備が必要） |

### B-8. テスト追加が必要な箇所

- 新機能の単体テスト
- 既存機能との結合テスト
- 後方互換性テスト
- 異常系テスト

### B-9. ドキュメント更新が必要な箇所

- README.md
- runbook.md
- 新機能用ドキュメント
- glossary.md（用語追加）

### B-10. 影響範囲が S-6 を壊さないか評価

**評価結果**: 多くの項目で S-6 への影響が大きい

- 自動リトライ: 中程度の影響（設定追加）
- マルチプロセス: 大きな影響（設計変更）
- ログローテーション: 小さな影響（追加スクリプト）
- 監視アラート: 小さな影響（外部連携）
- リモート実行: 大きな影響（設計変更）
- GUI: 小さな影響（別アプリ）
- クロスプラットフォーム: 中程度の影響（互換性確保）

---

## C. 優先順位とスコープ

### C-1. Must/Should/Could 分類

| 分類 | 項目 |
|------|------|
| Must | なし |
| Should | 自動リトライ、ログローテーション |
| Could | マルチプロセス、監視アラート |
| スコープ外 | リモート実行、GUI、クロスプラットフォーム |

### C-2. Must の上位3つ

**該当なし**

現時点で「必須」とすべき項目はない。S-6 stable の安定運用が優先される。

### C-3. Should の上位3つ

1. **自動リトライ**: API 一時障害への対応として有用
2. **ログローテーション**: 長期運用の管理負荷軽減
3. （なし）

### C-4. Could は凍結候補

以下は S-7 以降でも優先度が低く、凍結候補：

- マルチプロセス（現行速度で十分な場合）
- 監視アラート（外部ツールで代替可能）

### C-5. スコープ外（やらないこと）

以下は S-7 のスコープ外とする：

1. リモート実行（設計変更が大きすぎる）
2. GUI（別プロジェクトとして検討すべき）
3. クロスプラットフォーム（需要が不明）

### C-6. 1回目リリースで絶対に入れない項目

- リモート実行
- GUI
- クロスプラットフォーム
- マルチプロセス（検証不足）

### C-7. MVP（最小）仕様

**S-7 MVP（仮）**:

1. 自動リトライ機能（config で有効/無効切替可能）
2. リトライ回数・間隔の設定
3. リトライログの記録

### C-8. MVP の非目標（やらないこと）

- 複雑なリトライ戦略（指数バックオフなど）
- リトライ対象エラーのカスタマイズ
- 並列リトライ

### C-9. PoC で済ませる条件

以下の場合は PoC で終了とし、本実装は見送る：

1. 自動リトライが複雑すぎる場合
2. 既存動作への影響が大きすぎる場合
3. 運用負荷が軽減されない場合

### C-10. Stable に戻る条件（撤退条件）

以下の場合は S-7 を中止し、S-6 stable に戻る：

1. S-7 の変更が S-6 の安定性を損なう場合
2. テストで重大な問題が発見された場合
3. 業務要件が変更され、不要になった場合
4. リソースが確保できない場合

---

## D. 進め方

### D-1. S-7 を進める場合のフェーズ分割案

| フェーズ | 内容 | 期間目安 |
|---------|------|---------|
| S-7a | 自動リトライ設計・PoC | 1週間 |
| S-7b | 自動リトライ実装・テスト | 1週間 |
| S-7c | ログローテーション設計・実装 | 1週間 |
| S-7d | 安定化・ドキュメント整備 | 1週間 |

### D-2. 各フェーズの成功条件

| フェーズ | 成功条件 |
|---------|---------|
| S-7a | 設計ドキュメント完成、PoC で動作確認 |
| S-7b | 自動リトライ機能が正常動作、テスト通過 |
| S-7c | ログローテーションが正常動作 |
| S-7d | 全テスト通過、ドキュメント完成 |

### D-3. 各フェーズのチェックポイント名案

- S-7a: `S-7a_retry_design`
- S-7b: `S-7b_retry_impl`
- S-7c: `S-7c_logrotate`
- S-7d: `S-7d_stable`

### D-4. 各フェーズのテスト方針

- 各フェーズ完了時に test モード実行
- 既存機能の後方互換性テスト
- 新機能の単体テスト
- S-6 相当の動作確認

### D-5. 各フェーズのログ方針

- 既存ログ形式を維持
- 新機能のログは追加フィールドとして実装
- ログスキーマ変更は最小限

### D-6. 失敗時の戻り先

- 各フェーズの開始時チェックポイントに戻る
- 最悪の場合、S-6 stable（`de2cb84`）に戻る

### D-7. 50指示一括運用の可否

**可否**: 可（条件付き）

条件:
- 各フェーズを 50 指示以内に収める
- フェーズ間で状態を確認
- 問題発生時は即座に中断

### D-8. 指示粒度を落とす条件

以下の場合は指示粒度を 20-30 指示に落とす：

- 設計が複雑な場合
- 影響範囲が予想以上に大きい場合
- テストで問題が多発する場合

### D-9. 正史更新の手順（v1.0→v1.1など）

1. S-7 完了時に正史コンテキスト v1.1 を定義
2. README.md, runbook.md を更新
3. glossary.md に新用語を追加
4. release_notes.md に S-7 変更を記載

### D-10. S-7 検討結果を残すファイル名

- 本ドキュメント: `docs/s7_proposal.md`
- 承認後の設計: `docs/s7_design.md`（必要時に作成）
- 実装ログ: `docs/s7_impl_log.md`（必要時に作成）

---

## E. 結論

### E-1. S-7 の必要性判断

**結論: 保留**

### E-2. 判断理由

1. **S-6 stable が本日（2025-12-14）完成したばかり**
   - S-6 governance では「30日以上の安定運用」が拡張検討の条件
   - 現時点では条件を満たさない

2. **明確な業務要件がない**
   - 自動リトライ、ログローテーションは「あると便利」レベル
   - 現行運用で致命的な問題は発生していない

3. **現行機能で運用可能**
   - S-6 stable の機能で日常運用は可能
   - 限界は既知であり、受け入れられている

4. **リソースの優先順位**
   - まずは S-6 stable の安定運用を優先
   - 拡張は安定運用が確認されてから

### E-3. 次のアクション

1. **S-6 stable を 30 日間運用**
   - 安定性を確認
   - 運用上の課題を収集

2. **課題収集後に再検討**
   - 実際の運用で問題が発生した場合に再検討
   - 業務要件が明確になった場合に再検討

3. **本ドキュメントを正史に残す**
   - S-7 検討の記録として保存
   - 再検討時の参考資料とする

### E-4. 再検討のトリガー

以下の場合に S-7 検討を再開する：

1. API エラーが頻発し、自動リトライが必須となった場合
2. ログ管理が運用負荷となった場合
3. 新たな業務要件が発生した場合
4. S-6 stable が 30 日以上安定運用された場合

---

## 正史コンテキスト v1.0 との整合

本ドキュメントは正史コンテキスト v1.0 に準拠しています。

- S-7 は「検討」段階であり、実装は行わない
- 本ドキュメントは検討記録として正史に残す
- 結論が「保留」であることを明記

### 正史更新履歴

- 2025-12-14: S-7 検討A 実施
- 2025-12-14: 結論「保留」を記録
