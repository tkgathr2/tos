# S-6 Stable フェーズ

## フェーズ定義

**S-6 stable フェーズは 2025-12-14 に開始しました。**

S-6 は TOS v0.3 の **安定運用フェーズ** です。

### S-6 の目的

S-5 で確立した機能を安定運用し、実運用環境での継続的な利用を可能にする。

### フェーズ名の固定

- フェーズ名: **S-6 stable**
- ステータス: **現行フェーズ（運用中）**
- 前フェーズ: S-5 experimental（履歴フェーズ）

---

## Stable 運用ルール

### 許可される変更

S-6 stable フェーズで **許可** される変更：

1. **ドキュメントの修正・追加**
   - 誤字脱字の修正
   - 説明の明確化
   - 運用例の追加

2. **ログ文言の修正**
   - ログメッセージの明確化
   - 文言の統一

3. **コメントの追加・修正**
   - コード内コメントの追加
   - 既存コメントの修正

4. **軽微なバグ修正**
   - 動作に影響を与えない範囲
   - 承認後に実施

5. **テストの追加**
   - 既存機能のテスト追加
   - 動作確認用スクリプトの追加

### 禁止される変更

S-6 stable フェーズで **禁止** される変更：

1. **新機能の追加**
   - 既存機能の拡張も含む
   - 新しい設定項目の追加
   - 新しいモードの追加

2. **仕様変更**
   - 入出力フォーマットの変更
   - 処理ロジックの変更
   - エラーハンドリングの変更

3. **破壊的変更**
   - 既存データの削除
   - 後方互換性を壊す変更

4. **設定スキーマ変更**
   - config_v0_3.json のスキーマ変更
   - 既存設定項目の削除

5. **依存関係の変更**
   - 新しいライブラリの追加
   - 既存ライブラリのバージョン変更

### 実装変更の承認条件

実装コードの変更が必要な場合、以下の条件をすべて満たす必要があります：

1. バグ修正であること（機能追加ではない）
2. 既存の動作に影響を与えないこと
3. checkpoint を作成してから変更すること
4. 変更後に test モードで検証すること
5. 問題があれば即座に rollback すること

### 設定変更の申請ルール

config_v0_3.json の値を変更する場合：

1. 変更前に checkpoint を作成
2. 変更内容を記録（何を、なぜ変更したか）
3. 変更後に test モードで検証
4. 問題があれば rollback

---

## 運用ルール

### ログ出力の必須条件

- すべての実行で SummaryFile を出力する
- ログは logs/ 配下に保存される
- step_*.json は実行ごとに生成される

### 再現性確認の必須手順

1. cleanrun で初期状態から実行
2. test モードで状態確認
3. 同じ入力で同じ出力が得られることを確認

### rollback 実行必須条件

以下の場合、即座に rollback を実行する：

- test モードが失敗した場合
- 予期しない phase になった場合
- API エラーが連続した場合
- 出力が期待と異なる場合

### 障害発生時の初動手順

1. **即座に実行を停止**
2. **現状のログを保存**（logs/ 配下をコピー）
3. **rollback を実行**
4. **test モードで状態確認**
5. **障害内容を記録**

### 責任範囲

- 運用者は本 runbook に従って実行する責任を負う
- 正史コンテキストに反する運用は自己責任
- 障害発生時は初動手順に従う責任を負う

### サポート対象範囲

サポート対象：
- 本リポジトリのドキュメントに記載された使用方法
- 正史コンテキスト v1.0 に準拠した運用

サポート対象外：
- ドキュメントに記載のない独自拡張
- 正史に反する運用
- S-5 以前のフェーズ

---

## 標準実行フロー

### 基本フロー

```
checkpoint → cleanrun → test → (run 繰り返し) → job_loop_complete
```

### モードの使い分け

| モード | 用途 | 使用タイミング |
|--------|------|---------------|
| cleanrun | 初期化実行 | 新規開始時、状態リセット時 |
| test | 状態確認 | 実行後の検証、問題調査時 |
| run | 継続実行 | job_loop 継続時 |
| checkpoint | チェックポイント作成 | 重要な変更前 |
| rollback | 復旧 | 問題発生時 |

### job_loop 運用ルール（安定版）

1. **開始前**: 必ず checkpoint を作成
2. **初回**: cleanrun で実行
3. **継続**: run モードで job_loop_complete まで繰り返し
4. **完了確認**: test モードで job_result.json の存在を確認
5. **問題時**: 即座に rollback

### job_input/job_result 運用注意点

- job_input.json は実行前に配置
- job_input.example.json をテンプレートとして使用
- job_result.json は job_loop_complete 時に自動生成
- job_result.json の内容を確認してから次の作業へ

### API キー管理ルール

- OPENAI_API_KEY / ANTHROPIC_API_KEY を環境変数に設定
- API キーをコードやログにハードコードしない
- API キーを git にコミットしない

### ログ保存期間の方針

- logs/steps/ 配下は実行ごとに上書きされる
- 重要なログは別途バックアップを取る
- checkpoint を作成すると git に保存される

---

## トラブルシューティング

### 実行失敗時の報告フロー

1. エラーメッセージを記録
2. logs/ 配下のファイルを保存
3. rollback を実行
4. 障害内容を報告

### 運用者向け注意事項

- 実行前に必ず checkpoint を作成する
- test モードで状態確認を怠らない
- API キーの有効期限に注意
- ログを定期的に確認する
- 問題が発生したら即座に rollback

### 想定トラブル例

#### 1. API エラー

- **症状**: API 呼び出しでエラーが発生
- **原因**: API キー期限切れ、レート制限、ネットワーク障害
- **対処**: API キーを確認、時間をおいて再実行

#### 2. job_loop が完了しない

- **症状**: job_loop_complete にならない
- **原因**: max_jobs 設定ミス、実行中断
- **対処**: config_v0_3.json を確認、cleanrun から再開

#### 3. 予期しない phase

- **症状**: done や job_loop_complete 以外の phase
- **原因**: deny, fatal_error, stopped など
- **対処**: ログを確認、rollback して cleanrun から再開

### トラブル時の判断基準

| 状態 | 判断 | アクション |
|------|------|-----------|
| test 成功 | 正常 | 運用継続 |
| test 失敗 | 異常 | rollback |
| deny phase | 設定問題 | config 確認後 rollback |
| fatal_error | システム問題 | ログ確認後 rollback |
| API エラー | 一時的問題 | 再試行または rollback |

---

## 正史コンテキスト v1.0

S-6 stable は正史コンテキスト v1.0 に準拠しています。

- S-5 で確立した仕様を継承
- 正史に反する変更は禁止
- 本ドキュメントが唯一の正しい情報源

### 正史更新履歴

- 2025-12-14: S-5 closeout 完了
- 2025-12-14: S-6 stable 開始
