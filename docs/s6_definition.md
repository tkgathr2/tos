# S-6 定義書（stable）

本ドキュメントは S-6 フェーズの定義を50項目で確定します。**実装は含まれません。**

---

## A. フェーズ定義（1–10）

### 1. S-6 の正式名称

**TOS v0.3 S-6 stable**

### 2. S-6 の目的（1文）

S-6 は、experimental フェーズで確立した機能を「安定版」として運用可能な状態に固定し、仕様・動作・出力形式を保証することを目的とする。

### 3. S-5 との差分

| 項目 | S-5 (experimental) | S-6 (stable) |
|------|-------------------|--------------|
| 仕様 | 保証なし | 保証あり |
| 動作 | 保証あり | 保証あり |
| 出力形式 | 保証なし | 保証あり |
| 設定スキーマ | 変更可能 | 凍結 |
| ステータス | experimental | stable |

### 4. S-6 で変わらないもの

- orchestrator_v0_3.py の処理ロジック
- config_v0_3.json のスキーマ
- cc_run.ps1 のモード（run/test/cleanrun/checkpoint/rollback）
- job_input.json / job_result.json の形式
- phase_summary.json / step_log の形式
- フォルダ構成（workspace/, logs/, tools/, docs/）

### 5. S-6 で変えてよいもの

- ドキュメントの追加・修正
- ログメッセージの修正（内容を変えない範囲）
- コメントの追加・修正
- バグ修正（動作に影響を与えない範囲）
- テストの追加

### 6. experimental 解除条件

以下のすべてを満たす場合、experimental フラグを解除できる：

1. S-5 closeout が完了している
2. 全ての S-5 機能が動作確認済み
3. ドキュメントが整備されている
4. 破壊的変更が発生していない
5. 正史コンテキストに矛盾がない

### 7. stable の定義

**stable = 動作保証あり・仕様保証あり・出力形式保証あり**

| 保証項目 | 内容 |
|---------|------|
| 動作保証 | 同一入力に対して同一動作を保証 |
| 仕様保証 | 文書化された仕様どおりに動作 |
| 出力形式保証 | 出力ファイルの形式が変更されない |

---

## B. 保証範囲（11–20）

### 11. 動作保証の範囲

以下の動作を保証する：

- cc_run.ps1 の全モード（run/test/cleanrun/checkpoint/rollback）
- orchestrator_v0_3.py のフェーズ遷移
- job_loop の完了判定（job_loop_complete）
- checkpoint/rollback の Git 操作
- ログファイルの生成

### 12. 非保証事項

以下は保証対象外：

- AI API の応答内容（OpenAI / Anthropic の出力）
- 外部環境の変化（OS アップデート、Python バージョン変更）
- ネットワーク障害
- ディスク容量不足
- 権限エラー

### 13. 入力保証条件

以下の条件を満たす入力に対して動作を保証：

- config_v0_3.json が有効な JSON 形式
- job_input.json が有効な JSON 形式（存在する場合）
- 必須環境変数（OPENAI_API_KEY, ANTHROPIC_API_KEY）が設定済み
- Python 3.12+ がインストール済み
- PowerShell が利用可能

### 14. 出力保証条件

以下の出力形式を保証：

| ファイル | 形式 | 保証 |
|---------|------|------|
| phase_summary.json | JSON | スキーマ固定 |
| job_result.json | JSON | スキーマ固定 |
| last_run_summary.json | JSON | スキーマ固定 |
| last_run_summary.txt | 1行テキスト | フォーマット固定 |
| step_*.json | JSON | スキーマ固定 |

### 15. ログ保証条件

- step_log は各ステップ終了時に生成される
- phase_summary.json はフェーズ終了時に生成される
- last_run_summary.* は cc_run.ps1 終了時に生成される（-SummaryFile 指定時）
- ログファイルは上書きされない（新規生成のみ）

### 16. 再現性保証の前提条件

以下の条件下で再現性を保証：

1. 同一の config_v0_3.json
2. 同一の job_input.json（使用する場合）
3. 同一の phase_state.json（継続実行の場合）
4. 同一の Python バージョン
5. 同一の API キー

**注意**: AI API の応答は非決定的であるため、処理内容の再現性は保証しない。

### 17. rollback 保証条件

以下の条件で rollback を保証：

- checkpoint が正常に作成されている
- Git リポジトリが正常な状態
- 未コミットの変更がない（clean working tree）
- last_checkpoint.txt が存在する（-TargetCommit 未指定時）

### 18. 想定外入力の扱い

想定外入力に対する動作：

| 入力 | 動作 |
|------|------|
| 不正な JSON | エラー終了（exit code 1） |
| 存在しないファイルパス | エラー終了 |
| 空の config | エラー終了 |
| 不正な mode 指定 | 使用方法表示 |

### 19. エラー分類の扱い方針

| エラー種別 | 動作 | 復旧方法 |
|-----------|------|---------|
| deny | 停止（stop_on_deny=true時） | 設定変更または rollback |
| fatal_error | 停止 | ログ確認後に再実行または rollback |
| stopped | 停止 | 原因調査後に対処 |

### 20. 保証対象外ケース

以下のケースは明示的に保証対象外：

1. config_v0_3.json の手動破損
2. Git リポジトリの破損
3. OS レベルの障害
4. メモリ不足
5. 同時実行（複数インスタンス）
6. Python パッケージの互換性問題

---

## C. 運用ルール（21–30）

### 21. stable 運用時の変更許可ルール

| 変更内容 | 許可 | 承認 |
|---------|------|------|
| ドキュメント修正 | 許可 | 不要 |
| バグ修正 | 許可 | 必要 |
| ログメッセージ修正 | 許可 | 不要 |
| 機能追加 | 禁止 | - |
| 仕様変更 | 禁止 | - |
| スキーマ変更 | 禁止 | - |

### 22. ドキュメント更新ルール

- 誤字脱字の修正: 即時可
- 説明の追加・明確化: 即時可
- 新規ドキュメント追加: 正史との整合性確認後に可
- 既存ドキュメント構成変更: 承認後に可

### 23. 設定変更ルール

- config_v0_3.json の値変更: 許可（スキーマ内）
- config_v0_3.json のスキーマ変更: 禁止
- 新規設定項目追加: 禁止
- 既存設定項目削除: 禁止

### 24. ログ保管ポリシー

| ログ種別 | 保管期間 | 削除ルール |
|---------|---------|-----------|
| step_*.json | 無期限 | 手動削除のみ |
| phase_summary.json | 無期限 | cleanrun で削除 |
| last_run_summary.* | 上書き | 次回実行時 |
| last_checkpoint.txt | 上書き | 次回 checkpoint 時 |

### 25. チェックポイント作成頻度

- 大きな変更前: 必須
- 日次運用: 推奨（週1回以上）
- 問題発生時: 即時作成推奨

### 26. rollback 実行ルール

1. rollback 前に現状を checkpoint で保存（任意）
2. rollback 実行
3. rollback 後に自動 test が実行される
4. test 失敗時は原因調査

### 27. CI 導入可否の方針

- **現時点では導入しない**
- 将来的に導入する場合は S-7 以降で検討
- 導入時は test mode の exit code を利用

### 28. 外部連携の扱い方針

- AI API（OpenAI / Anthropic）: 現状維持
- Git（GitHub）: 現状維持
- 新規外部連携: S-7 以降で検討

### 29. 複数人運用時のルール

- 同一マシンでの同時実行: 禁止
- 異なるマシンでの実行: 許可（独立した環境）
- Git 競合時: 手動マージ

### 30. 正史更新ルール

- 正史コンテキスト v1.0 は S-6 で凍結
- 正史の更新は v1.1 以降で行う
- 更新時は全ドキュメントとの整合性を確認

---

## D. 境界と禁止事項（31–40）

### 31. stable で禁止される変更

1. **機能追加**: 新しいモード、新しい設定項目
2. **仕様変更**: 処理ロジックの変更、出力形式の変更
3. **スキーマ変更**: config/出力 JSON のスキーマ変更
4. **依存関係変更**: 新規ライブラリ追加、バージョン変更
5. **破壊的変更**: 後方互換性を壊す変更

### 32. 暗黙仕様化の禁止

**暗黙の仕様は禁止する。**

- 動作がドキュメント化されていない場合、それは「仕様」ではない
- ドキュメント化されていない動作に依存してはならない
- 発見された暗黙仕様は明文化するか、廃止する

### 33. 推測実装の禁止

**推測による実装は禁止する。**

- 「おそらくこう動くべき」という推測で実装しない
- 仕様が不明な場合は確認を優先する
- 確認できない場合は実装しない

### 34. AI 単独判断の禁止範囲

以下の判断を AI が単独で行うことを禁止：

1. 仕様の解釈
2. 破壊的変更の実施
3. 正史の変更
4. フェーズの変更
5. 設定スキーマの変更

### 35. 正史無視運用の禁止

**正史コンテキストを無視した運用は禁止する。**

- 正史に記載された制約を守る
- 正史に矛盾する変更を行わない
- 正史の存在を前提として運用する

### 36. フェーズ逆行の禁止

**フェーズの逆行は禁止する。**

- S-6 → S-5 への逆行: 禁止
- S-6 → S-4 への逆行: 禁止
- フェーズは前進のみ（S-6 → S-7）

### 37. 例外対応の承認ルール

例外対応が必要な場合：

1. 例外の内容を文書化
2. 影響範囲を明確化
3. 承認を得る
4. 実施後に正史を更新

### 38. 緊急対応時の例外ルール

緊急時（セキュリティ脆弱性等）の例外：

1. 即時対応を優先
2. 対応後に文書化
3. 事後承認を得る
4. 正史を更新

### 39. 境界逸脱時の対処方針

境界を逸脱した場合：

1. 即時停止
2. rollback を検討
3. 原因を調査
4. 再発防止策を文書化

### 40. 破壊的変更の定義（再確認）

以下を破壊的変更と定義：

1. 既存の入力形式で動作しなくなる変更
2. 既存の出力形式が変わる変更
3. 既存の設定が使えなくなる変更
4. 既存のログ形式が変わる変更
5. 既存のコマンドが使えなくなる変更

---

## E. 引き継ぎ・将来（41–50）

### 41. S-6 引き継ぎ最小セット

S-6 を引き継ぐために最低限必要なもの：

1. **コード**: orchestrator_v0_3.py, config_v0_3.json, tools/
2. **ドキュメント**: README.md, docs/runbook.md, docs/s6_definition.md
3. **設定**: 有効な API キー
4. **環境**: Python 3.12+, PowerShell, Git

### 42. 初見者が読む順番

1. README.md（概要・Quick Start）
2. docs/runbook.md（運用詳細）
3. docs/s5_definition.md（experimental 定義）
4. docs/s6_definition.md（stable 定義）
5. docs/architecture.md（アーキテクチャ）
6. docs/release_notes.md（変更履歴）

### 43. runbook / README の役割再定義

| ドキュメント | 対象者 | 内容 |
|-------------|-------|------|
| README.md | 初見者 | 概要、Quick Start、リンク集 |
| runbook.md | 運用者 | 詳細な使用方法、設定、トラブルシューティング |

### 44. example の位置づけ

- example は存在しない（S-6 では作成しない）
- 必要な場合は S-7 以降で検討
- Quick Start が example の役割を果たす

### 45. 今後の拡張フェーズ命名規則

| フェーズ | 命名 | 意味 |
|---------|------|------|
| S-7 | S-7 | 次の安定版または機能追加 |
| S-8 | S-8 | その次のフェーズ |
| ... | ... | 連番で継続 |

- フェーズ名は `S-N` 形式（N は正の整数）
- experimental / stable のサフィックスを付与可能

### 46. S-7 以降の存在可否

**S-7 以降は存在可能だが、現時点では未定義。**

- S-7 の開始条件: S-6 stable 運用の安定確認後
- S-7 の内容: 別途検討（機能追加、リファクタリング等）
- S-7 の開始は明示的な宣言が必要

### 47. 技術負債の扱い方針

- S-6 では技術負債の解消を行わない
- 技術負債はリスト化して管理
- 解消は S-7 以降で検討

### 48. 廃止判断ルール

TOS を廃止する場合の条件：

1. 代替システムの存在
2. 運用コストが利益を上回る
3. セキュリティリスクが許容不可
4. 維持困難な技術負債の蓄積

廃止時の手順：

1. 廃止宣言
2. データ移行期間の設定
3. ドキュメントのアーカイブ
4. リポジトリのアーカイブ

### 49. 正史 v1.x 更新条件

正史コンテキストを v1.1 以降に更新する条件：

1. S-6 stable 運用が安定している
2. 更新内容が明確に定義されている
3. 既存の正史との整合性が確認されている
4. 全ドキュメントの更新が完了している

### 50. S-6 定義完了宣言文

---

## S-6 定義完了宣言

本ドキュメントをもって、**TOS v0.3 S-6 stable の定義を完了**します。

- **定義日**: 2024-12-14
- **定義者**: Claude Code
- **項目数**: 50項目

### 定義内容

1. **フェーズ定義** (1-10): S-6 の目的、S-5 との差分、stable の意味
2. **保証範囲** (11-20): 動作保証、入出力保証、エラー分類
3. **運用ルール** (21-30): 変更許可、ログ保管、チェックポイント
4. **境界と禁止事項** (31-40): 禁止変更、暗黙仕様、AI 判断制限
5. **引き継ぎ・将来** (41-50): 最小セット、命名規則、廃止ルール

### 次のステップ

1. S-5 closeout の完了確認
2. experimental フラグの解除判断
3. S-6 stable 運用の開始

**以上をもって、S-6 定義を完了します。**

---
