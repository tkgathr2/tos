# TOS v0.3 S-6 エスカレーション手順

**S-6 stable 運用窓口・エスカレーション定義（最終版）**

**本ドキュメントは最終版です。S-6 stable は封印済みのため、改修依頼は受け付けません。**

---

## 運用窓口の定義

### 一次窓口（運用者）

| 項目 | 内容 |
|------|------|
| 役割 | 日常運用・軽微な問題対応 |
| 担当者 | ________________ |
| 連絡先 | ________________ |
| 対応時間 | ________________ |

**責任範囲**:
- 日次/週次/月次ルーチンの実行
- ログ確認・記録
- 軽微な問題の対応
- 障害報告の作成

### 二次窓口（開発者）

| 項目 | 内容 |
|------|------|
| 役割 | 重大問題対応・技術判断 |
| 担当者 | ________________ |
| 連絡先 | ________________ |
| 対応時間 | ________________ |

**責任範囲**:
- 原因不明エラーの調査
- rollback 判断
- ドキュメント更新（S-6 運用ルール内）
- 再発防止策の策定

---

## 障害レベルの定義

### レベル1: 軽微

**定義**: 運用者だけで完結できる問題

**条件**:
- ログ確認で原因が特定できる
- 再実行で解消する
- サービスへの影響がない
- ドキュメントに対処法が記載されている

**例**:
- 一時的なネットワークエラー（リトライで解消）
- 入力ファイルの形式エラー（修正で解消）
- 環境変数の未設定（設定で解消）

**対応**:
1. ログを確認して原因を特定
2. ドキュメントに従って対処
3. 正常終了を確認
4. 日次ログに記録

### レベル2: 重大

**定義**: 開発者への即連絡が必要な問題

**条件**:
- 原因が不明
- 再現性がある
- ドキュメントに対処法がない
- サービスへの影響がある可能性

**例**:
- 未知のエラーメッセージ
- 同じエラーが複数回発生
- phase が異常な状態
- ログに矛盾がある

**対応**:
1. 実行を停止
2. ログセットを収集
3. 障害報告テンプレートに記入
4. **開発者へ即連絡**
5. 指示を待つ（勝手に直さない）

### レベル3: 停止

**定義**: 実行停止・rollback 判断が必要な問題

**条件**:
- 実行継続が不可能
- データ破損の可能性
- セキュリティに影響する可能性
- 複数システムに影響

**例**:
- 致命的エラー（fatal_error）が発生
- ファイルシステムエラー
- 認証情報の問題
- 外部システムとの連携障害

**対応**:
1. **即座に実行を停止**
2. ログセットを収集（可能な範囲で）
3. **開発者へ緊急連絡**
4. rollback の判断を仰ぐ
5. 指示があるまで何もしない

---

## 報告に必須な項目

障害報告には以下の情報を必ず含めること。

### 必須項目

| 項目 | 取得方法 | 例 |
|------|---------|-----|
| 発生日時 | 手動記録 | 2025-12-14 10:30:00 |
| 障害レベル | 上記定義に従い判断 | レベル2: 重大 |
| commit hash | `git rev-parse HEAD` | abc1234 |
| 実行したコマンド | 手動記録 | cc_run.ps1 -Mode run |
| エラーメッセージ | ログから転記 | API error: 401 |

### 追加項目（可能な範囲で）

| 項目 | 取得方法 |
|------|---------|
| 直近のコミット履歴 | `git log -5 --oneline` |
| 変更差分 | `git status` |
| フェーズ状態 | `Get-Content workspace/phase_state.json` |
| 実行サマリー | `Get-Content logs/last_run_summary.txt` |
| ステップログ | `logs/steps/step_*.json` |

### ログ収集コマンド

```powershell
cd C:\Users\takag\00_dev\tos

# 必須情報
git rev-parse HEAD
git log -5 --oneline
git status

# 状態情報
Get-Content logs/last_run_summary.txt
Get-Content workspace/phase_state.json

# ステップログ（最新5件）
Get-ChildItem logs/steps/ | Sort-Object LastWriteTime -Descending | Select-Object -First 5 | ForEach-Object { Get-Content $_.FullName }
```

---

## 障害時のタイムライン記録ルール

障害発生時は以下の形式でタイムラインを記録すること。

### タイムライン記録テンプレート

```
## 障害タイムライン

| 時刻 | 対応者 | 内容 |
|------|--------|------|
| HH:MM | 名前 | 障害検知 |
| HH:MM | 名前 | ログ収集開始 |
| HH:MM | 名前 | 開発者へ連絡 |
| HH:MM | 名前 | 原因特定 |
| HH:MM | 名前 | 対処実施 |
| HH:MM | 名前 | 正常復旧確認 |
| HH:MM | 名前 | 障害報告完了 |
```

### 記録のポイント

- 発生から復旧までの全アクションを記録
- 時刻は分単位で記録
- 対応者名を必ず記載
- 判断の理由も記録（「〇〇のため××を実施」）

---

## 再発防止の書き方テンプレート

### 再発防止セクションテンプレート

```
## 再発防止

### 原因分析

**直接原因**: （障害を直接引き起こした要因）

**根本原因**: （直接原因が発生した背景・構造的問題）

### 対策

| No. | 対策内容 | 担当 | 期限 | 状態 |
|-----|---------|------|------|------|
| 1 | | | | |
| 2 | | | | |

### 効果確認

- [ ] 対策が完了したことを確認
- [ ] 同様の障害が発生しないことを確認
- [ ] ドキュメントを更新（必要な場合）
```

### 再発防止のポイント

- 「注意する」「気をつける」は対策ではない
- 仕組みで防ぐ対策を優先
- 対策には必ず担当と期限を設定
- 効果確認を必ず行う

---

## 勝手に直さない

**障害発生時、運用者が独自判断で修正することを禁止する。**

### 禁止の理由

1. **原因特定前の修正は問題を複雑化させる**
   - 何が原因だったか分からなくなる
   - 別の問題を引き起こす可能性がある

2. **ログが上書きされると調査が困難になる**
   - 証拠が失われる
   - 再発防止策が立てられなくなる

3. **正史コンテキストに違反する可能性がある**
   - ドキュメントにない操作は禁止
   - 独自拡張は禁止

### 正しい対応

1. 障害を検知したら、まずログを収集
2. 障害報告テンプレートに記入
3. 運用窓口へ連絡
4. **指示を待つ**
5. 指示に従って対応

### 例外（運用者が対応してよいケース）

- ドキュメントに対処法が明記されている
- レベル1（軽微）と明確に判断できる
- 対処後、必ず日次ログに記録する

---

## エスカレーションフロー図

```
障害発生
    │
    ▼
ログ確認で原因特定できるか？
    │
    ├─ Yes ─► レベル1（軽微）
    │         │
    │         ▼
    │         ドキュメントに対処法あり？
    │         │
    │         ├─ Yes ─► 運用者で対応 ─► 日次ログ記録
    │         │
    │         └─ No ──► レベル2（重大）へ
    │
    └─ No ──► レベル2（重大）
              │
              ▼
              ログ収集 → 障害報告作成
              │
              ▼
              開発者へ連絡
              │
              ▼
              実行継続可能か？
              │
              ├─ Yes ─► 指示を待って対応
              │
              └─ No ──► レベル3（停止）
                        │
                        ▼
                        即座に実行停止
                        │
                        ▼
                        緊急連絡
                        │
                        ▼
                        rollback 判断を仰ぐ
```

---

## 連絡先一覧

| 役割 | 担当者 | 連絡先 | 備考 |
|------|--------|--------|------|
| 一次窓口（運用者） | ________________ | ________________ | 日常運用 |
| 二次窓口（開発者） | ________________ | ________________ | 重大問題 |
| 緊急連絡先 | ________________ | ________________ | 停止レベル |

※ 担当者名と連絡先は運用開始前に記入すること。

---

## 関連ドキュメント

- [TOS v0.3 FINAL](tos_v0_3_final.md) - **最終完了宣言**
- [s6_one_pager.md](s6_one_pager.md) - 1枚資料
- [s6_routines.md](s6_routines.md) - 定常運用ルーチン
- [failure_report_template.md](failure_report_template.md) - 障害報告テンプレート
- [runbook.md](runbook.md) - 運用手順ガイド
